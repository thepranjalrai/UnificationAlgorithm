Mostly working.
Testing required with complicated cases.
